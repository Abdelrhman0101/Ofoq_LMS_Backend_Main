<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معاينة الشهادة</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #2b6cb0; --accent2: #764ba2; --ink: #0b1a2b; --page-w: 1123px; --page-h: 794px; }
        html, body { margin:0; padding:0; height:100%; }
        body { font-family: 'Tajawal', 'Amiri', Tahoma, Arial, sans-serif; direction: rtl; color: var(--ink); background:#fff; }
        .page { position: relative; width: var(--page-w); height: var(--page-h); margin: 0 auto; }
        .bg-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        .content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 70%; max-width: 70%; line-height: 1.6; }
        /* جميع النصوص داخل الشهادة بولد */
        .content, .content * { font-weight: 700; }
        .title { font-size: 40px; font-weight: 800; margin-bottom: 10px; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .subtitle { font-size: 18px; margin-bottom: 16px; color: #1f2d3d; }
        .recipient-name { font-family: 'Amiri', 'Tajawal', Tahoma; font-size: 34px; font-weight: 700; margin: 10px auto 18px; display:inline-block; border-bottom: 2px solid var(--accent); padding-bottom: 6px; text-shadow: 0 1px 0 #fff, 0 2px 6px rgba(0,0,0,.12); }
        .course-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; color:#0d2f66; }
        .hours-pill { display:inline-block; padding: 4px 10px; border: 1px solid rgba(43,108,176,.25); border-radius: 999px; font-size: 14px; color:#2b6cb0; background: rgba(43,108,176,.08); }
        .diploma-badge { display:inline-block; padding: 6px 12px; border-radius: 999px; background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#fff; font-weight: 800; font-size: 22px; box-shadow: 0 6px 16px rgba(43,108,176,.25); margin: 0 6px; }
        .completion-date { font-size: 14px; margin-top: 10px; color:#2b2b2b; }
        .actions { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .actions button { background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#fff; border:none; padding:10px 16px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.15); }
        .actions button:hover { filter: brightness(1.05); }
        /* نمط آمن للطباعة يمنع مشاكل background-clip مع html2canvas */
        body.printing .title { background: none !important; color: var(--accent) !important; -webkit-background-clip: initial !important; background-clip: initial !important; text-shadow: 0 1px 1px rgba(0,0,0,.06); }
        @media print { .actions { display:none; } .title { background: none !important; color: var(--accent) !important; -webkit-background-clip: initial !important; background-clip: initial !important; } }
        .serial { position:absolute; bottom:18px; left:30px; font-size:12px; color:#0b1a2b; letter-spacing:.5px; }
    </style>
</head>
<body>
    <div class="page">
        <img class="bg-img" src="/storage/certifecate_cover.jpg" alt="certificate background" />
        <div class="content">
            <div class="title">شهادة</div>
            <div class="subtitle">تشهد منصة أفق للتعليم والتدريب أن الطالب</div>
            <div class="recipient-name" id="js-name">محمد أحمد</div>
            <div class="subtitle">قد حضر المقرر الدراسي</div>
            <div class="course-title" id="js-course">التخطيط الاستراتيجي والابتكار في المؤسسات الإعلامية</div>
            <div class="subtitle">بواقع <span id="js-hours" class="hours-pill">6 ساعات تدريبية</span></div>
            <div class="subtitle">ضمن دبلومة <span id="js-diploma" class="diploma-badge">بارع</span> وقد اجتاز الاختبار بنجاح وذلك وهذه شهادة منّا بذلك سائلين المولى عز وجل له دوام التوفيق والسداد</div>
            <div class="completion-date">بتاريخ <span id="js-date">2025-11-09</span></div>
        </div>
        <div class="serial" id="js-serial">OFQ-2025-ABC123</div>
    </div>

    <div class="actions">
        <button id="downloadPdfBtn" type="button">تحميل PDF</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        (function(){
            const params = new URLSearchParams(window.location.search);
            const def = {
                name: 'عبدالرحمن محمود السيد',
                course: 'التخطيط الاستراتيجي والابتكار في المؤسسات الإعلامية',
                hours: '6',
                diploma: 'بارع',
                date: new Date().toISOString().slice(0,10),
                serial: 'OFQ-2025-ABC123'
            };

            const get = (k) => params.get(k) || def[k];
            const formatArabicDate = (iso) => {
                try {
                    const d = new Date(iso + 'T00:00:00');
                    return new Intl.DateTimeFormat('ar-EG', { year:'numeric', month:'long', day:'numeric' }).format(d);
                } catch (e) {
                    return iso;
                }
            };
            const sanitizeFilename = (s) => String(s || '')
                .replace(/[\\/:*?"<>|]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            const setText = (id, text, formatter) => {
                const el = document.getElementById(id);
                if(!el) return;
                el.textContent = formatter ? formatter(text) : text;
            };

            setText('js-name', get('name'));
            setText('js-course', get('course'));
            setText('js-hours', get('hours'), (h) => `${h} ساعات تدريبية`);
            setText('js-diploma', get('diploma'));
            setText('js-date', get('date'), formatArabicDate);
            setText('js-serial', get('serial'));

            // PDF download
            const btn = document.getElementById('downloadPdfBtn');
            btn?.addEventListener('click', async () => {
                const pageEl = document.querySelector('.page');
                if (!pageEl) return;
                document.body.classList.add('printing');
                try {
                    const canvas = await html2canvas(pageEl, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: null });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    // توليد PDF بمقاس A4 واتجاه أفقي (landscape)
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                    const pw = pdf.internal.pageSize.getWidth();
                    const ph = pdf.internal.pageSize.getHeight();
                    // املأ الصفحة كاملةً لضمان تناسب الطباعة مع A4
                    pdf.addImage(imgData, 'PNG', 0, 0, pw, ph, undefined, 'FAST');
                    const nameText = document.getElementById('js-name')?.textContent || get('name') || 'الطالب';
                    const filename = `شهادة - ${sanitizeFilename(nameText)}.pdf`;
                    pdf.save(filename);
                } finally {
                    document.body.classList.remove('printing');
                }
            });
        })();
    </script>
</body>
</html>